<html>
<head>
<meta charset="UTF-8">
<title>Dig Deeper & Digger</title>
<style>
html, body {
	height: 100%;
	margin: 0;
}
body {
	background: black;
	display: flex;
	align-items: center;
	justify-content: center;
}
</style>
</head>
<body>
<canvas id="c" width="1200" height="800" />
<script>
canvas = document.getElementById("c");
c = canvas.getContext("2d");

// Load images and sounds.
// We use a progress counter to keep track of
// how many resources have been loaded at startup.
loadProgress = 0;
function loadImage(source) {
	loadProgress++;
	var image = new Image();
	image.src = source;
	image.addEventListener("load", function () {
		loadProgress--;
	});
	return image;
}
function loadSound(source) {
	loadProgress++;
	var sound = new Audio();
	sound.src = source;
	sound.addEventListener("canplaythrough", function() {
		loadProgress--;
	});
	return sound;
}
background = loadImage("assets/background.jpg");
backgroundGradient = loadImage("assets/gradient.png");
rockImages = [];
rockImages[0] = loadImage("assets/rock0.png");
rockImages[1] = loadImage("assets/rock1.png");
rockImages[2] = loadImage("assets/rock2.png");
rockImages[3] = loadImage("assets/rock3.png");
rockImages[4] = loadImage("assets/rock4.png");
digFrames = [];
digFrames[0] = loadImage("assets/dig0.png");
digFrames[1] = loadImage("assets/dig1.png");
digFrames[2] = loadImage("assets/dig2.png");
digFrames[3] = loadImage("assets/dig3.png");
digFrames[4] = loadImage("assets/dig4.png");
digFrames[5] = loadImage("assets/dig5.png");
digFrames[6] = loadImage("assets/dig6.png");
digFrames[7] = loadImage("assets/dig7.png");
digFrames[8] = loadImage("assets/dig8.png");
digFrames[9] = loadImage("assets/dig9.png");
carot = loadImage("assets/carot.png");
onion = loadImage("assets/onion.png");
eatSounds = [];
eatSounds[0] = loadSound("assets/eat0.ogg");
eatSounds[1] = loadSound("assets/eat1.ogg");
eatSounds[2] = loadSound("assets/eat2.ogg");
eatSounds[3] = loadSound("assets/eat3.ogg");

// Some constants to tweak the game.
GRAVITY = 0.25;
X_MOVE_SPEED = 8;
X_MOVE_FRAMES = 16;
FOOD_START_Y = 1000;
FOOD_VANISH_Y = -1000;
ONION_FREQUENCY = 0.2;
NEW_FOOD_TIME = 50;

moveDir = 0;
nextMoveDir = 0;
moveFrames = 0;
rocks = [];
foods = [];
time = 0;
backX = 0;
digFrame = 9999;
backFrame = 9999;
nextRockIn = 0;
holes = [];
loadingTime = 0;
food = [];

function move(dir) {
	if(moveFrames == 0) {
		moveDir = dir;
		moveFrames = X_MOVE_FRAMES;
	} else {
		nextMoveDir = dir;
	}
}
document.addEventListener("keydown", function(e) {
	LEFT_KEY = 37;
	RIGHT_KEY = 39;

	if (e.which === LEFT_KEY) {
		move(-1);
	}
	if (e.which === RIGHT_KEY) {
		move(1);
	}
});
document.addEventListener("mousedown", function(e) {
	if(e.offsetX < canvas.width/2) {
		move(-1);
	} else {
		move(1);
	}
});

function randInt(min, max) {
	return min + Math.floor(Math.random() * (max-min+1));
}

function randInterval(min, max) {
	return min + Math.random()*(max-min);
}

function randSign() {
	if(Math.random() < 0.5) {
		return 1;
	} else {
		return -1;
	}
}

function newRock() {
	var rock = {
		index: Math.floor(Math.random() * rockImages.length),
		x: randInterval(-20, 20),
		y: 100,
		rotation: 2 * Math.PI * Math.random(),
		rotationSpeed: randInterval(-0.3, 0.3),
		scale: randInterval(0.3, 0.7),
		xSpeed: randSign() * randInterval(4, 12),
		ySpeed: randInterval(-18, -17),
	}
	// Reuse a rock object that is not visible anymore. This saves some overhead.
	for(i = 0; i < rocks.length; i++) {
		if(rocks[i].scale < 0.02) {
			rocks[i] = rock;
			return;
		}
	}
	// Only enlarge the array if all rocks are still active.
	rocks.push(rock);
}

function newFood() {
	var centerX = canvas.width/2 + moveFrames * moveDir * X_MOVE_SPEED;
	var food = {
		x: centerX + randInt(-2, 2) * X_MOVE_SPEED * X_MOVE_FRAMES,
		y: FOOD_START_Y,
	};
	if(randInterval(0, 1) < ONION_FREQUENCY) {
		food.image = onion;
		food.scale = randInterval(0.6, 0.8);
		food.rotation = randInterval(-Math.PI/20, Math.PI/20);
	} else {
		food.image = carot;
		food.scale = randInterval(0.5, 0.7);
		food.rotation = randInterval(-Math.PI/2, 0);
	}
	// Reuse a food object that is not visible anymore. This saves some overhead.
	for(i = 0; i < foods.length; i++) {
		if(foods[i].y < FOOD_VANISH_Y) {
			foods[i] = food;
			return;
		}
	}
	// Only enlarge the array if all foods are still visible.
	foods.push(food);
}

function square(x) {
	return x*x;
}

lastEatSound = -1;
function randomEatSound() {
	var i = lastEatSound;
	while(i == lastEatSound) {
		i = randInt(0, eatSounds.length-1);
	}
	lastEatSound = i;
	return eatSounds[i];
}

function loop() {
	requestAnimationFrame(loop);

	if(loadProgress > 0) {
		c.clearRect(0, 0, canvas.width, canvas.height);
		c.font = "50px Arial";
		c.fillStyle = "#FF00FF";
		c.textAlign = "left";
		var textW = c.measureText("Loading..").width;
		var text = "Loading" + ".".repeat((loadingTime/25)%4);
		c.fillText(text, (canvas.width-textW)/2, canvas.height/2);
		loadingTime++;
		return;
	}

	// Make the canvas fill the whole screen height.
	canvas.height = window.innerHeight;

	// Update animations.
	var dx = -moveDir * X_MOVE_SPEED;
	backX = backX + dx;
	backX = (backX+background.width) % background.width - background.width;

	if(time % 4 == 0) {
		digFrame = (digFrame + 1) % digFrames.length;
	}

	nextRockIn = nextRockIn - 1;
	if(nextRockIn <= 0) {
		newRock();
		nextRockIn = randInterval(1, 4);
	}
	for(i = 0; i < rocks.length; i++) {
		rocks[i].rotation = rocks[i].rotation + rocks[i].rotationSpeed;
		rocks[i].scale = rocks[i].scale * 0.99;
		rocks[i].rotationSpeed = rocks[i].rotationSpeed * 0.98;
		rocks[i].x = rocks[i].x + rocks[i].xSpeed + dx;
		rocks[i].y = rocks[i].y + rocks[i].ySpeed;
		rocks[i].ySpeed = rocks[i].ySpeed + GRAVITY;
	}

	var digImg = digFrames[digFrame];
	var digY = canvas.height - 2.5*digImg.height;

	if(moveFrames > 0) {
		moveFrames--;
		if(moveFrames == 0) {
			moveDir = nextMoveDir;
			if(moveDir != 0) {
				moveFrames = X_MOVE_FRAMES;
			}
			nextMoveDir = 0;
		}
	}

	for(i = 0; i < holes.length; i++) {
		holes[i].x = holes[i].x + dx;
		holes[i].y = holes[i].y - 5;
	}

	var headX = canvas.width / 2;
	var headY = digY - 50;
	for(i = 0; i < foods.length; i++) {
		foods[i].x = foods[i].x + dx;
		foods[i].y = foods[i].y - 5;
		if(square(foods[i].x - headX) + square(foods[i].y - headY) < square(40)) {
			// TODO increment score. And show it.
			randomEatSound().play();
			foods[i].y = -9999;
		}
	}

	if(time % NEW_FOOD_TIME == 0) {
		newFood();
	}

	const HOLE_RADIUS = 80;
	holes.push({
		x: canvas.width / 2-5,
		y: digY+140,
	});

	// Draw.
	c.clearRect(0, 0, canvas.width, canvas.height);

	var backY = -(5*time % background.height);
	for(y = backY; y < canvas.height; y = y + background.height) {
		for(x = backX; x < canvas.width; x = x + background.width) {
			c.drawImage(background, x, y);
		}
	}

	for(i = 0; i < holes.length; i++) {
		c.beginPath();
		c.arc(holes[i].x, holes[i].y, HOLE_RADIUS, 0, 2*Math.PI, false);
		c.fillStyle = "black";
		c.fill();
	}

	for(i = 0; i < rocks.length; i++) {
		r = rocks[i];
		c.translate(canvas.width/2 + rocks[i].x, digY + 170 + rocks[i].y);
		c.rotate(rocks[i].rotation);
		c.scale(rocks[i].scale, rocks[i].scale);
		c.drawImage(rockImages[r.index], -rockImages[r.index].width/2, -rockImages[r.index].height/2);
		c.setTransform(1, 0, 0, 1, 0, 0);
	}

	for(i = 0; i < foods.length; i++) {
		c.translate(foods[i].x, digY + foods[i].y);
		c.rotate(foods[i].rotation);
		c.scale(foods[i].scale, foods[i].scale);
		c.drawImage(foods[i].image, -foods[i].image.width/2, -foods[i].image.height/2);
		c.setTransform(1, 0, 0, 1, 0, 0);
	}

	c.drawImage(digImg, (canvas.width - digImg.width) / 2, digY);

	for(y = 0; y < canvas.height; y = y + backgroundGradient.height) {
		c.drawImage(backgroundGradient, 0, y);
	}

	time = time + 1;
}
requestAnimationFrame(loop);
</script>
</body>
</html>
