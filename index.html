<html>
<head>
<meta charset="UTF-8">
<title>Dig Deeper & Digger</title>
<style>
html, body {
	height: 100%;
	margin: 0;
}
body {
	background: black;
	display: flex;
	align-items: center;
	justify-content: center;
}
</style>
</head>
<body>
<canvas id="c" width="1200" height="800" />
<script>
canvas = document.getElementById("c");
c = canvas.getContext("2d");

loadProgress = 0;
function loadImage(source) {
	loadProgress = loadProgress + 1;
	image = new Image();
	image.src = source;
	image.addEventListener("load", function () {
		loadProgress = loadProgress - 1;
	});
	return image;
}
background = loadImage("assets/background.jpg");
backgroundGradient = loadImage("assets/gradient.png");
rockImages = [];
rockImages[0] = loadImage("assets/rock0.png");
rockImages[1] = loadImage("assets/rock1.png");
rockImages[2] = loadImage("assets/rock2.png");
rockImages[3] = loadImage("assets/rock3.png");
rockImages[4] = loadImage("assets/rock4.png");
digFrames = [];
digFrames[0] = loadImage("assets/dig0.png");
digFrames[1] = loadImage("assets/dig1.png");
digFrames[2] = loadImage("assets/dig2.png");
digFrames[3] = loadImage("assets/dig3.png");
digFrames[4] = loadImage("assets/dig4.png");
digFrames[5] = loadImage("assets/dig5.png");
digFrames[6] = loadImage("assets/dig6.png");
digFrames[7] = loadImage("assets/dig7.png");
digFrames[8] = loadImage("assets/dig8.png");
digFrames[9] = loadImage("assets/dig9.png");

LEFT_KEY = 37;
UP_KEY = 38;
RIGHT_KEY = 39;
DOWN_KEY = 40;
moveDir = 0;
moveFrames = 0;
function move(dir) {
	if(moveFrames == 0) {
		moveDir = dir;
		moveFrames = 16;
	}
}
document.addEventListener("keydown", function(e) {
	if (e.which === LEFT_KEY) {
		move(-1);
	}
	if (e.which === RIGHT_KEY) {
		move(1);
	}
});
document.addEventListener("mousedown", function(e) {
	if(e.offsetX < canvas.width/2) {
		move(-1);
	} else {
		move(1);
	}
});

function randInterval(min, max) {
	return min + Math.random()*(max-min);
}

function randSign() {
	if(Math.random() < 0.5) {
		return 1;
	} else {
		return -1;
	}
}

function newRock() {
	rock = {
		index: Math.floor(Math.random() * rockImages.length),
		x: randInterval(-20, 20),
		y: 100,
		rotation: 2 * Math.PI * Math.random(),
		rotationSpeed: randInterval(-0.3, 0.3),
		scale: randInterval(0.3, 0.7),
		xSpeed: randSign() * randInterval(4, 12),
		ySpeed: randInterval(-18, -17),
	}
	// Reuse a rock object that is not visible anymore. This saves some overhead.
	for(i = 0; i < rocks.length; i++) {
		if(rocks[i].scale < 0.02) {
			rocks[i] = rock;
			return;
		}
	}
	// Only enlarge the array if all rocks are still active.
	rocks.push(rock);
}

time = 0;
backX = 0;
digFrame = 9999;
backFrame = 9999;
rocks = [];
nextRockIn = 0;
GRAVITY = 0.25;
holes = [];
loadingTime = 0;

function loop() {
	requestAnimationFrame(loop);

	if(loadProgress > 0) {
		c.clearRect(0, 0, canvas.width, canvas.height);
		c.font = "50px Arial";
		c.fillStyle = "#FF00FF";
		c.textAlign = "left";
		textW = c.measureText("Loading..").width;
		text = "Loading" + ".".repeat((loadingTime/25)%4);
		c.fillText(text, (canvas.width-textW)/2, canvas.height/2);
		loadingTime++;
		return;
	}

	canvas.height = window.innerHeight;

	// Update animations.
	if(time % 4 == 0) {
		digFrame = (digFrame + 1) % 10;
	}
	nextRockIn = nextRockIn - 1;
	if(nextRockIn <= 0) {
		newRock();
		nextRockIn = randInterval(1, 4);
	}
	for(i = 0; i < rocks.length; i++) {
		rocks[i].rotation = rocks[i].rotation + rocks[i].rotationSpeed;
		rocks[i].scale = rocks[i].scale * 0.99;
		rocks[i].rotationSpeed = rocks[i].rotationSpeed * 0.98;
		rocks[i].x = rocks[i].x + rocks[i].xSpeed;
		rocks[i].y = rocks[i].y + rocks[i].ySpeed;
		rocks[i].ySpeed = rocks[i].ySpeed + GRAVITY;
	}

	digImg = digFrames[digFrame];
	digY = canvas.height - 2.5*digImg.height;

	dx = -moveDir * 8;
	backX = backX + dx;

	if(moveFrames > 0) {
		moveFrames--;
		if(moveFrames == 0) {
			moveDir = 0;
		}
	}

	for(i = 0; i < holes.length; i++) {
		holes[i].x = holes[i].x + dx;
		holes[i].y = holes[i].y - 5;
	}

	// Draw.
	c.clearRect(0, 0, canvas.width, canvas.height);

	backY = -(5*time % background.height);
	backX = (backX+background.width) % background.width - background.width;
	for(y = backY; y < canvas.height; y = y + background.height) {
		for(x = backX; x < canvas.width; x = x + background.width) {
			c.drawImage(background, x, y);
		}
	}

	HOLE_RADIUS = 80;
	holes.push({
		x: canvas.width / 2-5,
		y: digY+140,
	});

	for(i = 0; i < holes.length; i++) {
		c.beginPath();
		c.arc(holes[i].x, holes[i].y, HOLE_RADIUS, 0, 2*Math.PI, false);
		c.fillStyle = "black";
		c.fill();
	}

	for(i = 0; i < rocks.length; i++) {
		r = rocks[i];
		c.translate(canvas.width/2 + rocks[i].x, digY + 170 + rocks[i].y);
		c.rotate(rocks[i].rotation);
		c.scale(rocks[i].scale, rocks[i].scale);
		c.drawImage(rockImages[r.index], -rockImages[r.index].width/2, -rockImages[r.index].height/2);
		c.setTransform(1, 0, 0, 1, 0, 0);
	}

	c.drawImage(digImg, (canvas.width - digImg.width) / 2, digY);

	for(y = 0; y < canvas.height; y = y + backgroundGradient.height) {
		c.drawImage(backgroundGradient, 0, y);
	}

	time = time + 1;
}
requestAnimationFrame(loop);
</script>
</body>
</html>
